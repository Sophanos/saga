name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run typecheck

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run lint || true

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - name: Run AI E2E Tests
        run: bunx vitest convex/ai/__tests__ --run
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

  e2e:
    if: ${{ vars.RUN_E2E == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run e2e:install
      - name: Run Playwright E2E (Expo Web)
        run: bun run e2e:expo
        env:
          PLAYWRIGHT_START_SERVERS: "true"
          PLAYWRIGHT_TARGETS: "expo-web"
          EXPO_PUBLIC_E2E: "true"
          E2E_MOCK_AI: "true"
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          EXPO_PUBLIC_CONVEX_URL: ${{ secrets.CONVEX_URL }}
