{"id":"muse-1y3","title":"Chat Session History - Database persistence for chat sessions with session list UI","description":"Implemented durable chat session storage:\n- Supabase migration for chat_sessions and chat_messages tables with RLS\n- Database types and query functions in @mythos/db\n- Zustand store extended with session management actions\n- useSessionHistory hook for session CRUD and message persistence\n- SessionList UI component with history toggle\n- Integration with useSagaAgent for automatic message persistence\n- Sessions are private per-user within projects\n\nCode Review Fixes Applied:\n- Fixed race condition in ensureCurrentSession with promise deduplication\n- Added explicit userId to session creation\n- Consolidated 3 duplicate persist functions into 1\n- Fixed delete trigger to recalculate last_message_at\n- Added accessibility (aria-pressed, aria-label) to session list\n- Added error feedback for openSession failures\n- Added cleanup effect for sessionEnsurePromises\n- Moved formatRelativeTime to shared utils","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T02:15:47.118094+01:00","updated_at":"2025-12-30T02:43:48.950781+01:00","closed_at":"2025-12-30T02:16:00.073723+01:00","labels":["ai","chat","persistence"]}
{"id":"muse-2df","title":"Hetzner + Qdrant + Cloudflare Integration","description":"Set up Qdrant vector DB on Hetzner with Cloudflare Tunnel for secure access.\n\nServer: ssh -i ~/.ssh/hetzner_orchestrator root@78.47.165.136\n\nSetup Steps:\n- [ ] SSH into Hetzner, check if Qdrant running: docker ps | grep qdrant\n- [ ] Install Qdrant if needed (Docker with API key)\n- [ ] Create saga_vectors collection (4096 dims, Cosine, HNSW)\n- [ ] Configure UFW firewall rules\n\nCloudflare Tunnel:\n- [ ] Create tunnel: cloudflared tunnel create qdrant-tunnel\n- [ ] Route DNS: qdrant.saga.dev (or similar)\n- [ ] Configure /etc/cloudflared/config.yml\n- [ ] Enable systemd service\n\nTesting (curl):\n- [ ] Health check: curl https://qdrant.domain.com/collections\n- [ ] Collection info: curl .../collections/saga_vectors\n- [ ] Insert test vector\n- [ ] Search test vector\n- [ ] Delete test vector\n\nEnvironment Variables:\n- [ ] QDRANT_URL (Cloudflare tunnel URL)\n- [ ] QDRANT_API_KEY\n- [ ] QDRANT_COLLECTION=saga_vectors\n- [ ] Add to Supabase Edge Function secrets\n\nRef: /Users/mibook/saga/docs/QDRANT_SETUP.md","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T06:02:10.605013+01:00","updated_at":"2025-12-30T01:20:17.156871+01:00","closed_at":"2025-12-30T01:20:17.156871+01:00"}
{"id":"muse-2gl","title":"Replace fake /try UI with real app","description":"Replaced AnonymousApp fake chat UI with TrialApp showing real Layout with trial banner","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T01:19:01.332917+01:00","updated_at":"2025-12-30T01:19:15.396902+01:00","closed_at":"2025-12-30T01:19:15.396902+01:00"}
{"id":"muse-2ph","title":"Image Tools Robustness: retry logic, error handling, caching","description":"Add robustness improvements to Phase 1-4 image tools:\n\n## Retry Logic\n- [ ] Add exponential backoff for OpenRouter/Gemini API failures\n- [ ] 3 retry attempts with 1s, 2s, 4s delays\n- [ ] Distinguish retryable vs non-retryable errors\n\n## Error Handling\n- [ ] Parse provider-specific errors into user-friendly messages\n- [ ] Add \"Try Again\" button in ToolResultCard for failed generations\n- [ ] Log errors with context for debugging\n\n## Input Validation\n- [ ] Stricter image size limits (pre-upload validation)\n- [ ] Prompt length validation with helpful error messages\n- [ ] Base64 data URL format validation\n\n## Caching / Deduplication\n- [ ] Hash prompt → check if identical image exists\n- [ ] Offer \"use existing\" before regenerating\n- [ ] Track generation params for cache key\n\n## Timeout UX\n- [ ] Better timeout messages with estimated wait time\n- [ ] Progress indication for long operations\n- [ ] Cancel button that properly aborts\n\nFiles to update:\n- supabase/functions/ai-image/index.ts\n- supabase/functions/ai-image-analyze/index.ts\n- apps/web/src/tools/executors/generateImage.ts\n- apps/web/src/tools/executors/analyzeImage.ts\n- apps/web/src/tools/executors/createEntityFromImage.ts\n- apps/web/src/tools/executors/illustrateScene.ts","notes":"2025-12-30: Implemented core robustness improvements:\n- Fixed timeout signal not being passed in generateImage\n- Fixed abort/timeout detection (ApiError.code instead of AbortError)\n- Disabled auto-retry for costly endpoints (prevent duplicates)\n- Added centralized timeout config\n- Added client-side image size validation\n- Added retryCount, startedAt, errorCode, errorStatusCode to ChatToolInvocation\n- Expanded ApiErrorCode with server error codes\n\nRemaining items for future work:\n- Caching/deduplication\n- Progress indication improvements\n- Expected duration hints","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T04:49:55.90303+01:00","updated_at":"2025-12-30T05:17:17.452336+01:00","labels":["ai","image","robustness"]}
{"id":"muse-3jr","title":"MLP 3.x: Vercel AI SDK 6 Capabilities","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T01:57:23.739442+01:00","updated_at":"2025-12-30T01:57:23.739442+01:00","labels":["epic"]}
{"id":"muse-3jr.1","title":"Multi-step Agents (maxSteps)","description":"AI chains tools autonomously without roundtrips. Use maxSteps: 5 in streamText. SDK: maxSteps in streamText. Effort: 1 day. Priority: High Value + Low Effort","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T01:57:43.856199+01:00","updated_at":"2025-12-30T01:57:43.856199+01:00","dependencies":[{"issue_id":"muse-3jr.1","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:43.857385+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.10","title":"Telemetry","description":"OpenTelemetry tracing for debugging. SDK: experimental_telemetry. Effort: 0.5 day. Priority: Nice to have","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-30T01:57:50.047707+01:00","updated_at":"2025-12-30T01:57:50.047707+01:00","dependencies":[{"issue_id":"muse-3jr.10","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:50.048647+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.11","title":"GenUI: Entity Cards","description":"Stream entity preview cards during creation. Leverage existing GenUI infrastructure.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-30T01:57:59.336335+01:00","updated_at":"2025-12-30T01:57:59.336335+01:00","dependencies":[{"issue_id":"muse-3jr.11","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:59.337483+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.12","title":"GenUI: Relationship Diagrams","description":"Generate mini-graphs inline in chat showing entity relationships.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-30T01:57:59.524912+01:00","updated_at":"2025-12-30T01:57:59.524912+01:00","dependencies":[{"issue_id":"muse-3jr.12","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:59.526747+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.13","title":"GenUI: Timeline Widgets","description":"Visual timeline for story events rendered inline in chat.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-30T01:57:59.716712+01:00","updated_at":"2025-12-30T01:57:59.716712+01:00","dependencies":[{"issue_id":"muse-3jr.13","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:59.71743+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.14","title":"GenUI: Character Sheets","description":"Interactive stat blocks in chat for characters with editable fields.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-30T01:57:59.935024+01:00","updated_at":"2025-12-30T01:57:59.935024+01:00","dependencies":[{"issue_id":"muse-3jr.14","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:59.93596+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.2","title":"Prompt Caching","description":"Cache system prompts, reduce costs 90%. SDK: providerOptions.anthropic.cacheControl. Effort: 0.5 day. Priority: High Value + Low Effort","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T01:57:44.550171+01:00","updated_at":"2025-12-30T01:57:44.550171+01:00","dependencies":[{"issue_id":"muse-3jr.2","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:44.55112+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.3","title":"File Attachments","description":"Upload images/files in chat, AI analyzes them. SDK: experimental_attachments. Effort: 1 day. Priority: High Value + Low Effort","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T01:57:45.247828+01:00","updated_at":"2025-12-30T01:57:45.247828+01:00","dependencies":[{"issue_id":"muse-3jr.3","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:45.248619+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.4","title":"Reasoning Tokens","description":"Claude extended thinking, show reasoning to users. SDK: experimental_reasoning. Effort: 0.5 day. Priority: High Value + Low Effort","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T01:57:45.943327+01:00","updated_at":"2025-12-30T01:57:45.943327+01:00","dependencies":[{"issue_id":"muse-3jr.4","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:45.944362+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.5","title":"Image Generation","description":"Generate images from prompts (DALL-E, Stability). SDK: experimental_generateImage(). Effort: 1 day. Priority: High Value + Medium Effort","notes":"Completed as part of muse-4d5 Phases 1-4. generate_image, analyze_image, create_entity_from_image, illustrate_scene tools all implemented.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T01:57:46.638999+01:00","updated_at":"2025-12-30T04:49:31.9095+01:00","closed_at":"2025-12-30T04:49:31.909515+01:00","dependencies":[{"issue_id":"muse-3jr.5","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:46.639755+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.6","title":"Image Editing","description":"Add edit_image tool for modifying existing images using AI SDK 6 generateImage with reference images.\n\n## AI SDK 6 Image Editing Pattern\n```typescript\nimport { generateImage } from \"ai\";\nimport { blackForestLabs } from \"@ai-sdk/black-forest-labs\";\n\nconst { images } = await generateImage({\n  model: blackForestLabs.image(\"flux-kontext-pro\"),\n  prompt: {\n    text: \"Edit this to add a scar across the left eye\",\n    images: [\"https://example.com/portrait.png\"], // Reference image\n  },\n});\n```\n\n## Use Cases\n- Character aging (\"Age this character 20 years\")\n- Injury/scar addition (\"Add a scar across the left eye\")\n- Costume change (\"Change to battle armor\")\n- Mood/expression change (\"Make expression more menacing\")\n- Style transfer (\"Convert to manga style\")\n- Time of day (\"Change to nighttime lighting\")\n- Background extension (outpainting)\n\n## Implementation\n- [ ] edit_image tool definition (server)\n- [ ] ai-image-edit edge function or extend ai-image with kind:\"edit\"\n- [ ] Client executor with asset resolution\n- [ ] UI for selecting source image + edit instruction\n\nModels to consider:\n- bfl/flux-kontext-pro (best for editing)\n- bfl/flux-kontext-max (higher quality)\n- google/gemini-2.5-flash-image (multimodal)","notes":"Depends on Phase 1-4 complete. Can use flux-kontext-pro via OpenRouter for high-quality edits.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T01:57:47.338381+01:00","updated_at":"2025-12-30T05:40:11.683043+01:00","closed_at":"2025-12-30T05:40:11.683043+01:00","dependencies":[{"issue_id":"muse-3jr.6","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:47.339488+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.7","title":"PDF/Doc Analysis","description":"Extract text from uploaded docs. SDK: experimental_createProviderRegistry. Effort: 1 day. Priority: High Value + Medium Effort","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T01:57:47.927397+01:00","updated_at":"2025-12-30T01:57:47.927397+01:00","dependencies":[{"issue_id":"muse-3jr.7","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:47.928274+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.8","title":"Computer Use","description":"UI automation via screenshots. SDK: experimental_computer_tool. Effort: 3 days. Priority: Experimental/Future","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-30T01:57:48.647028+01:00","updated_at":"2025-12-30T01:57:48.647028+01:00","dependencies":[{"issue_id":"muse-3jr.8","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:48.648217+01:00","created_by":"daemon"}]}
{"id":"muse-3jr.9","title":"MCP Integration","description":"Connect external tool servers. SDK: experimental_createMCPClient. Effort: 2 days. Priority: Experimental/Future","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-30T01:57:49.29682+01:00","updated_at":"2025-12-30T01:57:49.29682+01:00","dependencies":[{"issue_id":"muse-3jr.9","depends_on_id":"muse-3jr","type":"parent-child","created_at":"2025-12-30T01:57:49.297718+01:00","created_by":"daemon"}]}
{"id":"muse-3nn","title":"Mobile Capture Hub - Implementation Reference","description":"Reference document for Mobile Capture Hub implementation. Focus shifting to web - this captures what was built for mobile foundation.","design":"# Mobile Capture Hub - Implementation Reference\n\n## Overview\nThis document captures what was implemented for the Mobile Capture Hub feature. The focus is shifting to web, so this serves as a reference for the mobile foundation that was built.\n\n---\n\n## Wave 1: Foundation \u0026 Infrastructure (COMPLETED)\n\n### 1. Shared State Foundation\n**File:** `packages/state/src/progressive.ts`\n\nCreated comprehensive Zustand store with:\n- **Writer Archetype:** `architect | gardener | hybrid` with selectors\n- **Milestones Tracking:** word_count, chapter_complete, entity_created goals\n- **UI Visibility State:** Progressive disclosure controls\n- **Captures Inbox State:** Full CRUD for CaptureRecord\n\nKey exports:\n```ts\n// Types\nexport type WriterArchetype, CaptureKind, CaptureStatus, CaptureRecord, Milestone, UIVisibility\n\n// Store\nexport const useProgressiveStore\n\n// Selectors (30+)\nexport const useWriterArchetype, useInboxCaptures, usePendingCaptures,\n  useCapturesByKind, useMilestones, useUIVisibility, useIsFeatureVisible...\n```\n\n### 2. Database Migration\n**File:** `packages/db/src/migrations/010_captures.sql`\n\nTable: `captures`\n- id, project_id, created_by, kind, status, title, content\n- media_url, media_mime_type, payload (jsonb), source\n- created_at, updated_at, processed_at\n\nRLS Policies:\n- SELECT: Projects user owns or is member of\n- INSERT: Own projects or editor role\n- UPDATE: Own captures or editor role\n- DELETE: Own captures or project owner\n\n**File:** `packages/db/src/queries/captures.ts`\n- getCaptures, getCapture, getCapturesByStatus, getCapturesByKind\n- createCapture, updateCapture, updateCaptureStatus, deleteCapture\n- getInboxCaptures, createCaptures, deleteCapturesByProject\n\n### 3. Sync Engine Extension\n**Files Modified:**\n- `packages/sync/src/types.ts` - Added `captures` to SyncTable, ProjectSnapshot, LocalDbAdapter\n- `packages/sync/src/syncEngine.ts` - Bootstrap, realtime, push/apply for captures\n- `packages/sync/src/native/sqliteDb.ts` - SQLite schema + CRUD for captures\n- `packages/sync/src/web/dexieDb.ts` - Dexie v2 upgrade + captures store\n\nLocalDbAdapter new methods:\n```ts\ngetCapture(id: string): Promise\u003cRecord\u003cstring, unknown\u003e | null\u003e;\ngetCaptures(projectId: string): Promise\u003cRecord\u003cstring, unknown\u003e[]\u003e;\nupsertCapture(capture: Record\u003cstring, unknown\u003e): Promise\u003cvoid\u003e;\ndeleteCapture(id: string): Promise\u003cvoid\u003e;\n```\n\n---\n\n## Wave 2: Mobile UI \u0026 Features (COMPLETED)\n\n### 4. Core Capture Types\n**Files:** `packages/core/src/inbox/types.ts`, `packages/core/src/inbox/index.ts`\n\nShared types for web + mobile:\n```ts\nexport type CaptureKind = \"text\" | \"voice\" | \"photo\" | \"flag\" | \"chat_plan\";\nexport type CaptureStatus = \"inbox\" | \"processed\" | \"archived\";\nexport type CaptureSource = \"mobile\" | \"web\";\n\nexport interface CaptureRecord { id, projectId, createdBy, kind, status, ... }\nexport interface VoiceCapturePayload { durationMs, transcription, language, localUri }\nexport interface PhotoCapturePayload { width, height, description, localUri }\nexport interface FlagCapturePayload { documentId, excerpt, paragraphIndex, ... }\nexport interface ChatPlanCapturePayload { conversationId, responseToSave, ... }\n\n// Helpers\ncaptureHasMedia(), captureNeedsProcessing(), getCaptureKindLabel(), getCaptureKindIcon()\n```\n\n### 5. Mobile Sync Integration\n**File:** `apps/mobile/lib/useSyncEngine.ts`\n- Opens expo-sqlite database\n- Creates SQLite adapter\n- Starts/stops SyncEngine on projectId changes\n- Subscribes to isOnline and calls engine.setOnline()\n- Exposes: mutate, queueAi, syncNow\n\n**File:** `apps/mobile/lib/useProjectSelection.ts`\n- Persists last selected projectId to AsyncStorage\n- Restores on app start\n\n**File:** `apps/mobile/app/_layout.tsx`\n- Added SyncProvider component\n- SyncStatusIndicator for visual feedback\n\n### 6. Capture UI Components\n**Files:** `apps/mobile/components/capture/`\n\n| Component | Description |\n|-----------|-------------|\n| CaptureFAB.tsx | Floating action button, animated, bottom-right |\n| CaptureModal.tsx | Bottom sheet with capture type options |\n| TextCaptureSheet.tsx | Quick text entry with title/content |\n| index.ts | Barrel exports |\n\n**File:** `apps/mobile/hooks/useCapture.ts`\n```ts\nexport function useCapture(): {\n  createTextCapture(input: { title?: string; content: string }): Promise\u003cstring\u003e;\n  createVoiceCapture(draft: { localUri, mimeType, durationMs? }): Promise\u003cstring\u003e;\n  createPhotoCapture(draft: { localUri, mimeType, width?, height? }): Promise\u003cstring\u003e;\n  createFlagCapture(draft: { documentId, excerpt, note? }): Promise\u003cstring\u003e;\n  isCreating: boolean;\n  error: string | null;\n}\n```\n\n---\n\n## NOT YET IMPLEMENTED (Mobile-specific)\n\n### Voice/Photo Capture\n- VoiceRecorder.tsx - expo-av recording\n- PhotoCapture.tsx - expo-image-picker or expo-camera\n- useCaptureProcessor.ts - background upload + AI processing\n\n### Edge Functions\n- ai-transcribe - Whisper transcription\n- ai-describe-image - Vision model description\n- ai-agent non-streaming mode for mobile\n\n### Mobile Navigation\n- (tabs)/_layout.tsx - Tab-based navigation\n- reader/[documentId].tsx - Manuscript viewing + highlighting\n\n### Mobile Chat\n- MobileChatBar.tsx - Bottom sheet chat\n- useMobileChat.ts - Non-streaming chat hook\n\n### World Browser\n- SemanticSearchBar.tsx - Entity search\n- RelationshipMiniGraph.tsx - SVG mini graph\n\n---\n\n## WEB INTEGRATION POINTS\n\nThe foundation is ready for web to consume:\n\n### From @mythos/state\n```ts\nimport { \n  useProgressiveStore,\n  useInboxCaptures,\n  usePendingCaptures,\n  useWriterArchetype,\n  useMilestones,\n  useUIVisibility,\n} from \"@mythos/state\";\n```\n\n### From @mythos/core\n```ts\nimport {\n  CaptureRecord,\n  CaptureKind,\n  getCaptureKindLabel,\n  getCaptureKindIcon,\n} from \"@mythos/core\";\n```\n\n### From @mythos/db\n```ts\nimport {\n  getCaptures,\n  getInboxCaptures,\n  updateCaptureStatus,\n} from \"@mythos/db\";\n```\n\n### Web Features to Build\n1. **Inbox Panel** - Display mobile captures as nudges\n2. **Capture Processing UI** - Review transcriptions, descriptions\n3. **Progressive Disclosure** - Use milestones + archetype for UX\n4. **Genesis Wizard** - Use progressive store for onboarding state\n","acceptance_criteria":"## Mobile Foundation (DONE)\n- [x] Captures table migration with RLS policies\n- [x] Sync engine extended for captures (types, adapters, engine)\n- [x] Progressive state store with archetype, milestones, UI visibility\n- [x] Core inbox types shared between web/mobile\n- [x] Mobile sync hook (useSyncEngine)\n- [x] Mobile project selection persistence\n- [x] CaptureFAB, CaptureModal, TextCaptureSheet components\n- [x] useCapture hook for creating captures\n\n## Mobile Remaining (DEFERRED - focus on web)\n- [ ] VoiceRecorder component (expo-av)\n- [ ] PhotoCapture component (expo-image-picker)\n- [ ] useCaptureProcessor for background AI processing\n- [ ] ai-transcribe edge function\n- [ ] ai-describe-image edge function\n- [ ] ai-agent non-streaming mode\n- [ ] Tabs navigation layout\n- [ ] Reader with entity highlighting\n- [ ] Mobile chat bar\n\n## Web Integration (NEXT PRIORITY)\n- [ ] Inbox panel showing mobile captures as nudges\n- [ ] Capture processing/review UI\n- [ ] Progressive disclosure using milestones\n- [ ] Genesis wizard using progressive store\n- [ ] Template picker for writer archetypes","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T07:20:53.413601+01:00","updated_at":"2025-12-29T07:25:41.261683+01:00","labels":["captures","mobile","reference","sync"]}
{"id":"muse-4d5","title":"Epic: AI Image Generation from Entity Data","description":"Phases 1-4 Complete (2024-12-30):\n\n## Phase 1: Core Generation ✅\n- project_assets table + entity portrait columns\n- generate_image tool with 17 art styles\n- ai-image edge function (OpenRouter → Gemini fallback)\n- Client executor with entity resolution\n- Quick actions (Portrait, Landscape, Item, Scene)\n\n## Phase 2: Visual Memory + Search ✅\n- saga_images Qdrant collection (512-dim CLIP)\n- DeepInfra CLIP embedding integration\n- search_images tool (text → image)\n- find_similar_images tool (image → image)\n- CLIP sync on generation (non-blocking)\n\n## Phase 3: Reference Image → Entity ✅\n- analyze_image tool (multimodal analysis)\n- create_entity_from_image tool (composite flow)\n- ai-image-analyze edge function\n- Visual description extraction schema\n- Portrait auto-linking on entity creation\n\n## Phase 4: Scene Composition ✅\n- illustrate_scene tool with sceneFocus options\n- ai-image extended with kind:\"scene\" routing\n- Character portrait references for consistency\n- Multimodal generation with portrait inputs\n\nCommit: 6b606eb\n\n## Remaining\n- Phase 5: Manga/Storyboard\n- Phase 6: Multi-Format Export\n- Robustness: retry logic, error handling, caching","notes":"Phases 1-4 complete. Core image generation, search, analyze, and scene composition all working.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-29T05:53:58.570419+01:00","updated_at":"2025-12-30T04:49:20.859685+01:00"}
{"id":"muse-4mj","title":"Epic: Visual Consistency \u0026 Control System","description":"Ensure generated images maintain consistency across the project. Leverages existing vector embeddings and AI analysis.\n\nKey Features:\n- Reference image upload and style locking\n- Character consistency via IP-Adapter/ControlNet\n- Scene illustration from prose context\n- Style presets per project (manga, realistic, painterly, etc.)\n- Visual embedding storage (link images to entity vectors)\n- AI analysis of generated images for consistency checking\n- Negative prompt learning from rejected generations\n\nIntegration Points:\n- World Graph visual style inheritance\n- Entity relationship affects scene composition\n- RAG retrieval includes visual context\n- Linter checks visual consistency (eye color, outfit, etc.)\n\nDepends on: muse-4d5 (AI Image Generation)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-29T05:54:08.322282+01:00","updated_at":"2025-12-29T05:54:08.322282+01:00"}
{"id":"muse-5kn","title":"Collaboration Feature - Multi-user project sharing","description":"## Overview\nMulti-user collaboration for Mythos projects.\n\n## Status: ~95% COMPLETE\n\n## Implemented \u0026 Wired Up\n- [x] **Database Schema**: project_members, project_invitations, activity_log with full RLS\n- [x] **DB Queries**: Full CRUD for members, invitations, activity\n- [x] **State Store**: Zustand collaboration store with all selectors\n- [x] **CollaboratorsBar**: Avatar stack, online indicators, wired in Header.tsx\n- [x] **InviteMemberModal**: Email invite with role selection, rendered in Header.tsx\n- [x] **MemberManagementModal**: Role changes, remove members, ownership transfer\n- [x] **ActivityFeed**: Time-grouped activity display\n- [x] **InviteAcceptPage**: Token-based acceptance at /invite/:token\n- [x] **useCollaboration Hook**: Real-time presence, called in Layout.tsx\n- [x] **invite-member Edge Function**: Sends emails via Resend API\n\n## Environment Variables Required\n```\nRESEND_API_KEY=your-resend-api-key\nINVITE_FROM_EMAIL=Mythos \u003cnoreply@mythos.dev\u003e\nAPP_URL=http://localhost:5173\n```\n\n## Remaining Work (Future Enhancements)\n- [ ] Real-time cursors/selections in editor (requires Tiptap integration)\n- [ ] Conflict resolution for concurrent edits\n- [ ] Activity notifications (in-app + email digest)\n- [ ] ActivityFeed placement in UI (component exists, needs sidebar location)\n\n## Key Files\n- `supabase/functions/invite-member/` - Email invitation edge function\n- `packages/db/src/migrations/007_collaboration.sql` - DB schema\n- `apps/web/src/hooks/useCollaboration.ts` - Realtime presence hook\n- `apps/web/src/components/collaboration/` - All UI components\n- `apps/web/src/components/Header.tsx` - CollaboratorsBar + InviteMemberModal wired","notes":"## Bug Fixes Applied (2025-12-29)\n\nCommit 0decab2 fixed all critical and high-severity issues:\n\n### Critical Fixes\n- connectionStatus converted from ref to useState (proper re-renders)\n- Email mismatch warning before invite acceptance (race condition fix)\n- ROLE_PERMISSIONS.editor.canInvite set to true (matches implementation)\n- ActivityLogEntry.id standardized as string with .toString()\n\n### High Severity Fixes\n- isMountedRef pattern for async cleanup (memory leak prevention)\n- Debounced refreshMembers (300ms) to prevent N requests\n- 10s timeout on Resend API with AbortController\n- emailSent boolean returned in invite response\n- resendInvitation now actually sends email\n- Member check before creating invitation\n\n### Performance Improvements\n- React.memo on Avatar, MemberListItem components\n- useMemo for sortedMembers, displayMembers arrays\n- Promise.all for parallel DB queries\n\n### Code Consolidation\n- Avatar component extracted to @mythos/ui\n- Time utils consolidated to @mythos/core\n- Email validation consolidated to @mythos/core\n- Activity mappers moved to @mythos/db\n- InviteMemberModal integrated with ModalHost\n- ProjectRole consolidated to @mythos/core\n- SQL migration 013 for expires_at index + activity logging\n\nStatus: Production-ready. All typechecks pass.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-29T16:40:13.347758+01:00","updated_at":"2025-12-30T01:20:17.299566+01:00","closed_at":"2025-12-30T01:20:17.299566+01:00","labels":["95-percent","bugfixes-applied","collaboration","role-management-complete","v1","wired-up"]}
{"id":"muse-7r3","title":"Onboarding flow integration","description":"Welcome screen, user preferences, first project setup wizard","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-29T02:34:18.836257+01:00","updated_at":"2025-12-29T02:34:18.836257+01:00","dependencies":[{"issue_id":"muse-7r3","depends_on_id":"muse-xpl","type":"parent-child","created_at":"2025-12-29T02:34:42.29269+01:00","created_by":"daemon"},{"issue_id":"muse-7r3","depends_on_id":"muse-x3g","type":"blocks","created_at":"2025-12-29T07:30:36.777156+01:00","created_by":"daemon"}],"comments":[{"id":1,"issue_id":"muse-7r3","author":"mibook","text":"Template Picker Modal implemented (cb6c1c8):\n\n**Components Created:**\n- TemplatePickerModal/ - Multi-step modal container\n- StartOptions.tsx - 3 paths: AI / Browse Templates / Start Blank\n- TemplateGrid.tsx - Category tabs + search (13 templates)\n- TemplateCard.tsx - Template preview card\n- CreateProjectForm.tsx - Name + Gardener/Architect toggle\n\n**Entry Points:**\n- ProjectSelectorScreen 'New Project' button\n- Header project dropdown (New Project, Switch Project)\n- Command palette (Cmd+K → 'New Project')\n- Global shortcut Cmd+N\n\n**Infrastructure:**\n- stores/navigation.ts - Cross-component project switching\n- Updated stores/index.ts with templatePicker modal type\n\n**Remaining:**\n- AI Template Builder (mini-chat) - placeholder exists\n- Welcome screen for first-time users\n- User preferences collection\n- Adaptive onboarding based on entry flow","created_at":"2025-12-29T14:28:47Z"}]}
{"id":"muse-7r3.1","title":"AI Template Builder - Complete","description":"Implemented AI Template Builder in TemplatePickerModal. Commit: 0fe67b1","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T16:05:33.824619+01:00","updated_at":"2025-12-29T16:05:52.959857+01:00","closed_at":"2025-12-29T16:05:52.959857+01:00","dependencies":[{"issue_id":"muse-7r3.1","depends_on_id":"muse-7r3","type":"parent-child","created_at":"2025-12-29T16:05:33.825695+01:00","created_by":"daemon"}]}
{"id":"muse-7r3.2","title":"Notion-style Try Before Signup Flow","description":"Implement anonymous session with context preservation on auth. Try Import/Chat without signup, merge to real account on auth.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-29T16:06:00.96123+01:00","updated_at":"2025-12-29T18:04:31.240166+01:00","closed_at":"2025-12-29T18:04:31.240166+01:00","dependencies":[{"issue_id":"muse-7r3.2","depends_on_id":"muse-7r3","type":"parent-child","created_at":"2025-12-29T16:06:00.961713+01:00","created_by":"daemon"}]}
{"id":"muse-8lj","title":"Connect chatbar to signup/app flow","description":"When user submits text/files in hero chatbar, redirect to signup or app with content preserved","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T02:34:18.986238+01:00","updated_at":"2025-12-29T02:34:18.986238+01:00","dependencies":[{"issue_id":"muse-8lj","depends_on_id":"muse-xpl","type":"parent-child","created_at":"2025-12-29T02:34:42.371164+01:00","created_by":"daemon"},{"issue_id":"muse-8lj","depends_on_id":"muse-dbv","type":"blocks","created_at":"2025-12-29T02:34:50.046164+01:00","created_by":"daemon"}]}
{"id":"muse-8uo","title":"Align Mythos UI design to Notion aesthetic","description":"Redesign Mythos UI components to match Notion's clean, minimal aesthetic.\n\n## Scope\n- Sidebar design (document tree, search, navigation)\n- Header/toolbar design\n- Console/panel design (Chat, Search, Linter tabs)\n- Editor chrome and toolbars\n- Modal and dropdown styling\n- Color palette alignment\n\n## Reference\n- Notion dark theme\n- Clean borders, subtle backgrounds\n- Refined typography\n- Minimal chrome, content-focused\n\n## Components to Update\n- Layout.tsx\n- Sidebar/Manifest components\n- Console/AISidebar components\n- Header components\n- Modal components\n- Editor toolbars\n\n## Already Done\n- FloatingAIChat (Notion-style)\n- Trial onboarding (inline document approach)\n- Auth screens\n- Landing page","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T02:40:53.249271+01:00","updated_at":"2025-12-30T02:40:53.249271+01:00"}
{"id":"muse-921","title":"Epic: Video Generation \u0026 Interactive World","description":"Abstract video generation and interactive world exploration for gaming/film studios.\n\nVideo Generation:\n- Scene-to-video from prose (RunwayML/Pika)\n- Character animation clips\n- Cinematic storyboard export\n- Trailer/pitch video compilation\n\nInteractive World:\n- Explorable 2D/3D world from World Graph\n- Location navigation with generated visuals\n- Character encounters at locations\n- Timeline scrubbing (see world at different story points)\n\nExport Formats:\n- Visual Novel skeleton (Ren'Py compatible)\n- Storyboard PDF (manga panel layout)\n- Game asset pack (sprites, backgrounds)\n- Film pitch deck with cinematics\n\nTarget Users:\n- Gaming studios (prototype cinematics)\n- Manga artists (storyboard generation)\n- Film/TV writers (pitch visualization)\n- Visual novel creators\n\nDepends on: muse-4mj (Visual Consistency)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T05:54:20.339073+01:00","updated_at":"2025-12-29T05:54:20.339073+01:00"}
{"id":"muse-9r6","title":"Mobile: Add story import feature","description":"Add import functionality to mobile app matching web implementation:\n- Create ImportModal component for React Native\n- Add file picker using expo-document-picker\n- Reuse import service from web (services/import)\n- Support Markdown, DOCX, EPUB, plain text formats\n- Add Import button to editor screen header\n- Progress tracking with cancel support","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T02:55:52.337048+01:00","updated_at":"2025-12-29T02:55:52.337048+01:00","dependencies":[{"issue_id":"muse-9r6","depends_on_id":"muse-9zi","type":"blocks","created_at":"2025-12-29T02:57:17.307531+01:00","created_by":"daemon"}]}
{"id":"muse-9zi","title":"Mobile: complete screen implementations","description":"Finish Projects, World, Settings screens with full functionality","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T02:34:19.054099+01:00","updated_at":"2025-12-29T02:34:19.054099+01:00","dependencies":[{"issue_id":"muse-9zi","depends_on_id":"muse-xpl","type":"parent-child","created_at":"2025-12-29T02:34:42.423178+01:00","created_by":"daemon"}]}
{"id":"muse-b5s","title":"Image UX Integration: portraits in WorldGraph, EntityForm, Manifest","description":"Integrate existing image tools into UI components for visual polish.\n\n## Components to Update\n- [ ] **EntityFormModal**: Portrait preview + \"Generate\"/\"Upload\" buttons\n- [ ] **EntityNode** (WorldGraph): Show portrait thumbnail in node\n- [ ] **EntityAvatar**: Portrait with fallback to initials\n- [ ] **Manifest panel**: Thumbnails in entity list\n- [ ] **Command Palette**: Image generation commands\n\n## Quick Actions Already Done ✅\n- Generate Portrait (character)\n- Generate Landscape (location)\n- Generate Item Icon\n- Illustrate Scene\n\n## Dependencies\n- Phase 1-4 image tools (complete)\n- Portrait URL stored on entities (complete)\n\n## Notes\nThese are visual polish items. The underlying tools work - this is about surfacing them in the UI consistently.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T04:51:16.908849+01:00","updated_at":"2025-12-30T04:51:16.908849+01:00","labels":["image","ui"]}
{"id":"muse-dbv","title":"Auth screens for website","description":"Auth screens for website - CORE COMPLETE\n\n## Completed\n- [x] AuthScreen component (sign-in, sign-up, forgot password modes)\n- [x] AuthCallback with OAuth handling\n- [x] PASSWORD_RECOVERY flow (set new password after reset link)\n- [x] Mobile auth (OAuth + email/password + forgot password)\n- [x] Auth state sync (Zustand + Supabase)\n- [x] Protected routes (web + mobile)\n- [x] Profile management\n\n## Remaining (Config Only)\n- [ ] Enable Google OAuth in Supabase dashboard\n- [ ] Enable Apple OAuth in Supabase dashboard\n- [ ] Test OAuth flow end-to-end in production\n- [ ] Email verification (optional, currently disabled)\n\nAuth is ~70% complete - all code is done, just needs OAuth provider config.","notes":"Google OAuth working on localhost:3001.","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-12-29T02:34:18.917461+01:00","updated_at":"2026-01-02T21:41:29.376941+01:00","labels":["70-percent","needs-oauth-config"],"dependencies":[{"issue_id":"muse-dbv","depends_on_id":"muse-xpl","type":"parent-child","created_at":"2025-12-29T02:34:42.331848+01:00","created_by":"daemon"}]}
{"id":"muse-gk6","title":"Epic: Centralized Capability Architecture","description":"Create a unified capability system that powers ALL AI features through a single registry.\n\n## Overview\nThis epic establishes a centralized capability architecture that serves as the single source of truth for all AI features. Capabilities can be invoked from:\n- Quick Actions (sidebar)\n- Command Palette (⌘K)\n- AI Agent tool calls (chat)\n- Profile-based preferences\n\n## Key Components\n1. **@mythos/capabilities package** - Registry with Capability types\n2. **check_logic tool** - Explicit rule enforcement (magic systems, causality, knowledge state)\n3. **name_generator tool** - Genre-aware, culture-sensitive name generation\n4. **Profile UI** - User preferences that influence AI behavior\n5. **UI Integration** - Wire registry into QuickActions + Command Palette\n\n## Architecture\n```\npackages/capabilities/\n├── src/\n│   ├── index.ts           # Registry + exports\n│   ├── types.ts           # Capability interface\n│   ├── registry.ts        # Central Map + helpers\n│   └── definitions/\n│       ├── analyze.ts     # check_logic, check_consistency, clarity_check\n│       ├── generate.ts    # name_generator, brainstorm\n│       ├── edit.ts        # entity operations\n│       └── coach.ts       # style analysis\n```\n\n## Capability Interface\n```typescript\ninterface Capability {\n  id: string;\n  kind: 'tool' | 'chat_prompt' | 'ui';\n  label: string;\n  icon: string;\n  category: 'analysis' | 'generation' | 'worldbuilding';\n  surfaces: ('quick_actions' | 'command_palette' | 'chat')[];\n  toolName?: ToolName;\n  buildPrompt?: (ctx) =\u003e string;\n  action?: UIAction;\n}\n```\n\n## Success Criteria\n- All AI features accessible via unified registry\n- QuickActions derived from registry (not hardcoded)\n- Command Palette AI commands derived from registry\n- Profile preferences influence AI tool behavior\n- New tools can be added by simply registering capability","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-29T17:22:55.323414+01:00","updated_at":"2025-12-29T17:22:55.323414+01:00","labels":["ai","architecture","capabilities"]}
{"id":"muse-gk6.10","title":"Profile + Capabilities Registry with Writer Personalization","description":"## Overview\nCentralized capability registry + Profile UI with writer personalization. Uses Qdrant for style learning and potential mem0 integration for long-term memory.\n\n## Writer Personalization via Qdrant\nLearn from writer's existing work:\n1. Embed writer's documents → analyze writing style\n2. Extract: sentence length, adverb tolerance, dialogue style, metaphor usage\n3. Store style profile in Qdrant for AI context\n4. AI adapts feedback/suggestions to match writer's voice\n\n## mem0 Integration (Future-Ready)\nPrepare architecture for mem0 or similar:\n- Store writer preferences, past decisions, rejected suggestions\n- Track what names/styles writer prefers\n- Remember context across sessions\n- Interface: `Memory.add()`, `Memory.search()`, `Memory.get()`\n\n## Capabilities Registry Package\n\n### packages/capabilities/\n```\nsrc/\n├── types.ts          # Capability, CapabilityContext, WritingPreferences\n├── registry.ts       # CAPABILITIES[], getCapabilitiesForSurface()\n├── index.ts          # Re-exports\n└── definitions/\n    ├── analyze.ts    # check_logic, check_consistency, clarity_check\n    ├── generate.ts   # name_generator, brainstorm\n    ├── edit.ts       # entity CRUD\n    └── coach.ts      # style analysis, SDT, pacing\n```\n\n### Capability Interface\n```typescript\ninterface Capability {\n  id: string;\n  kind: 'tool' | 'chat_prompt' | 'ui';\n  label: string;\n  icon: string;\n  category: 'analysis' | 'generation' | 'worldbuilding' | 'coach';\n  surfaces: ('quick_actions' | 'command_palette' | 'chat')[];\n  \n  // Execution\n  toolName?: ToolName;\n  buildPrompt?: (ctx: CapabilityContext) =\u003e string;\n  action?: UIAction;\n  \n  // Context requirements\n  requiresSelection?: boolean;\n  requiresProject?: boolean;\n  requiresApiKey?: boolean;\n  \n  // Qdrant context\n  needsWorldContext?: boolean;  // Query Qdrant for world data\n  needsStyleContext?: boolean;  // Query Qdrant for writer style\n}\n```\n\n## Profile UI + Preferences\n\n### Wire ProfileSettings into ModalHost\n- Add case 'profile' → render ProfileSettings\n- Add navigation from Header/Settings\n\n### Profile Preferences Schema\n```typescript\ninterface WritingPreferences {\n  // Genre \u0026 Style\n  preferredGenre?: string;\n  styleMode?: 'hemingway' | 'tolkien' | 'manga' | 'noir' | 'minimalist';\n  \n  // Naming\n  namingCulture?: NameCulture;\n  namingStyle?: 'short' | 'standard' | 'long';\n  \n  // Analysis\n  logicStrictness?: 'strict' | 'balanced' | 'lenient';\n  showDontTellSensitivity?: 'low' | 'medium' | 'high';\n  \n  // AI Behavior\n  aiMode?: 'strict' | 'suggestive' | 'generative';\n  coachVerbosity?: 'minimal' | 'balanced' | 'detailed';\n}\n```\n\n### Style Learning (Qdrant)\n```\nOn document save:\n1. Embed document text\n2. Store with payload: { type: 'user_writing', userId, projectId }\n\nOn AI request:\n1. Query Qdrant for user's writing samples\n2. Analyze style patterns\n3. Inject into AI prompt: 'Match this author's style...'\n```\n\n## UI Surface Integration\n\n### QuickActions.tsx\n- Replace hardcoded QUICK_ACTIONS with getCapabilitiesForSurface('quick_actions')\n- Add invokeCapability() handler\n\n### ai-commands.ts\n- Derive commands from getCapabilitiesForSurface('command_palette')\n- Add capability invoker adapter\n\n### invokeCapability.ts (new)\nCentral handler that routes based on capability.kind:\n- 'tool' → trigger tool execution\n- 'chat_prompt' → send prompt to chat\n- 'ui' → open modal/tab\n\n## Acceptance Criteria\n- [ ] @mythos/capabilities package created and working\n- [ ] Profile UI wired into app with preferences form\n- [ ] Preferences stored in profile.preferences JSONB\n- [ ] QuickActions derived from registry\n- [ ] Command Palette derived from registry\n- [ ] Qdrant stores writer's style samples\n- [ ] AI uses style context for personalized responses\n- [ ] Architecture ready for mem0 integration","notes":"Qdrant collection created - ready for manual testing of profile + capabilities personalization","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-29T17:30:29.988469+01:00","updated_at":"2025-12-30T01:00:31.580694+01:00","labels":["ai","capabilities","personalization","profile","qdrant"],"dependencies":[{"issue_id":"muse-gk6.10","depends_on_id":"muse-gk6","type":"parent-child","created_at":"2025-12-29T17:30:29.98944+01:00","created_by":"daemon"}]}
{"id":"muse-gk6.11","title":"Brainstorm Mode: Focused Writing with Mobile-Web Sync","description":"## Overview\nDistraction-free writing mode with timer/sprints, mobile capture integration, and AI-powered auto-sorting via Qdrant.\n\n## Core Concept (from Discord Research)\nWriters want: 'Throw in info, AI sorts it automatically'\n- Judgment-free idea capture\n- No interruptions during creative flow\n- Auto-organize after writing session\n\n## Mobile Integration (Foundation Exists)\nComponents built but NOT integrated:\n- CaptureFAB.tsx ✓\n- CaptureModal.tsx ✓\n- TextCaptureSheet.tsx ✓\n- Sync engine includes captures ✓\n\n### Mobile Tasks\n1. Integrate CaptureFAB into projects.tsx, editor/[id].tsx\n2. Add BrainstormSheet with:\n   - Distraction-free text area\n   - Timer (5/15/25/60 min sprints)\n   - Word count goal\n   - No AI during session (optional gentle prompts)\n3. Voice capture with transcription\n4. Photo capture with AI description\n\n## Web Integration\n\n### Inbox Panel\n- New console tab or sidebar section\n- Show unprocessed captures\n- Bulk actions: archive, delete, convert to entity\n\n### Freewrite View\n- Full-screen distraction-free editor\n- Timer overlay (optional)\n- Word count progress bar\n- Auto-save as capture\n- 'Exit \u0026 Process' button\n\n### Auto-Sort via Qdrant\n```\nCapture saved with status='inbox'\n       ↓\n1. Embed capture text\n2. Search Qdrant: similar entities, documents\n3. Run ai-detect: extract entity mentions\n4. AI proposes:\n   - 'This looks like info about Kael → Link to character?'\n   - 'New location detected: Thornwood → Create entity?'\n   - 'Related to Chapter 3 → Add as note?'\n       ↓\nUser reviews, approves/rejects\n       ↓\nstatus='processed'\n```\n\n## Sprint/Timer Mode\n```typescript\ninterface SprintSession {\n  duration: number;  // minutes\n  wordGoal?: number;\n  startedAt: Date;\n  wordsWritten: number;\n  captures: string[];  // IDs of captures created\n}\n```\n\nFeatures:\n- Countdown timer\n- Word count tracker\n- Gentle notification at milestones\n- Session summary at end\n- Track streaks across days\n\n## Database\nExisting captures table supports this:\n- kind: 'text' | 'voice' | 'photo' | 'flag' | 'chat_plan'\n- status: 'inbox' | 'processed' | 'archived'\n- payload: JSONB for session metadata\n\n## Acceptance Criteria\n- [ ] Mobile: CaptureFAB integrated into screens\n- [ ] Mobile: Brainstorm sheet with timer\n- [ ] Web: Inbox panel shows captures\n- [ ] Web: Freewrite view with timer\n- [ ] Qdrant: Auto-sort captures to entities\n- [ ] Sync: Captures flow mobile → web seamlessly\n- [ ] Sprint tracking with word goals","notes":"Qdrant collection created - ready for manual testing of mobile-web sync brainstorm capture","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-29T17:31:25.971549+01:00","updated_at":"2025-12-30T01:00:31.422464+01:00","labels":["ai","brainstorm","capture","mobile","qdrant"],"dependencies":[{"issue_id":"muse-gk6.11","depends_on_id":"muse-gk6","type":"parent-child","created_at":"2025-12-29T17:31:25.972564+01:00","created_by":"daemon"}]}
{"id":"muse-gk6.8","title":"check_logic: Rule Enforcement Engine with World Context","description":"## Overview\nComplete implementation of check_logic tool that enforces EXPLICIT story rules using world context from Qdrant.\n\n## Key Difference from check_consistency\n- check_consistency = AI INFERS problems (fuzzy)\n- check_logic = System ENFORCES defined rules (deterministic)\n\n## Qdrant Integration\nUse semantic search to:\n1. Find related magic system rules when analyzing text\n2. Retrieve character knowledge state from embeddings\n3. Pull power scaling context from similar entities\n4. Cross-reference cause-effect patterns in existing narrative\n\n## Implementation Scope\n\n### Types (agent-protocol)\n- LogicFocus: 'magic_rules' | 'causality' | 'knowledge_state' | 'power_scaling'\n- CheckLogicArgs: scope, text, focus[], strictness\n- LogicIssue: type, severity, violatedRule, suggestion, locations\n- CheckLogicResult: issues[], summary\n\n### Server (supabase/functions/_shared/)\n- tools/check-logic.ts - Tool definition with Zod schemas\n- tools/index.ts - Register in sagaTools\n- prompts/logic.ts - System prompt emphasizing EXPLICIT rules only\n- saga/executors.ts - executeCheckLogic with Qdrant context retrieval\n\n### Client (apps/web/src/)\n- tools/executors/checkLogic.ts - Extract rules from MagicSystem entities\n- tools/registry.ts - Register executor\n- Integration with linter panel for issue display\n\n### Qdrant Flow\n```\nUser triggers check_logic\n       ↓\n1. Extract text to analyze\n2. Query Qdrant: similar magic systems, characters, events\n3. Build context with rules[], limitations[], knowledge[]\n4. AI validates ONLY against explicit rules\n5. Return issues with violatedRule.ruleText\n       ↓\nDisplay in linter panel\n```\n\n## Acceptance Criteria\n- [ ] Only flags violations of EXPLICITLY stated rules\n- [ ] Uses Qdrant to retrieve relevant world context\n- [ ] Integrates with existing linter UI\n- [ ] Accessible via Quick Actions, Command Palette, Chat\n- [ ] Respects profile preferences (strictness level)","notes":"Qdrant collection created - ready for manual testing of rule enforcement with world context","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-29T17:29:21.957373+01:00","updated_at":"2025-12-30T01:00:31.874016+01:00","labels":["ai","analysis","qdrant","tool"],"dependencies":[{"issue_id":"muse-gk6.8","depends_on_id":"muse-gk6","type":"parent-child","created_at":"2025-12-29T17:29:21.959094+01:00","created_by":"daemon"}]}
{"id":"muse-gk6.9","title":"name_generator: World-Aware Name Generation with Qdrant","description":"## Overview\nComplete implementation of name_generator tool that generates genre-aware, culture-sensitive names using world context from Qdrant embeddings.\n\n## Qdrant Integration - Key Feature\nUse semantic search to:\n1. Find existing naming patterns in the world (how are elves named? how are cities named?)\n2. Retrieve cultural/linguistic context from existing entities\n3. Ensure new names FIT the established world aesthetic\n4. Avoid similar-sounding names that might confuse readers\n\n## Implementation Scope\n\n### Types (agent-protocol)\n- NameCulture: 'western' | 'norse' | 'japanese' | 'chinese' | 'arabic' | 'slavic' | 'celtic' | 'latin' | 'indian' | 'african' | 'custom'\n- NameGeneratorArgs: entityType, genre, culture, count, seed, avoid[], tone\n- GeneratedName: name, meaning, pronunciation, notes\n- NameGeneratorResult: names[], genre, culture\n\n### Server (supabase/functions/_shared/)\n- tools/name-generator.ts - Tool definition\n- tools/index.ts - Register in sagaTools\n- prompts/names.ts - System prompt with culture guidelines\n- saga/executors.ts - executeNameGenerator with Qdrant context\n\n### Client (apps/web/src/)\n- tools/executors/nameGenerator.ts - Apply preferences, avoid duplicates\n- tools/registry.ts - Register executor\n- components/modals/EntityFormModal.tsx - 'Generate Name' button\n- components/modals/NamePickerModal.tsx (optional) - Name selection UI\n\n### Qdrant Flow\n```\nUser requests names for 'character' in 'high_fantasy'\n       ↓\n1. Query Qdrant: existing characters in project\n2. Extract naming patterns (Norse? Celtic? Mixed?)\n3. Query Qdrant: existing locations, factions for world aesthetic\n4. Build context with existing names[], detected culture, world tone\n5. AI generates names that FIT the established world\n6. Filter out similar-sounding to existing names\n       ↓\nReturn names with meaning/pronunciation\n```\n\n## Entity Form Integration\n- Add sparkle button next to Name input field\n- Click → generate 5 names inline\n- Click name to apply\n- 'More' button for additional suggestions\n\n## Profile Preferences\n- Default culture from profile.preferences.namingCulture\n- Default genre from project or profile.preferences.preferredGenre\n\n## Acceptance Criteria\n- [ ] Names match existing world aesthetic via Qdrant\n- [ ] Avoids similar names to existing entities\n- [ ] Supports all entity types (character, location, item, faction, etc.)\n- [ ] Integrates with EntityFormModal\n- [ ] Accessible via Quick Actions, Command Palette, Chat\n- [ ] Includes meaning/pronunciation for constructed names","notes":"Qdrant collection created - ready for manual testing of world-aware name generation","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-29T17:29:50.3756+01:00","updated_at":"2025-12-30T01:00:31.726003+01:00","labels":["ai","generation","qdrant","tool"],"dependencies":[{"issue_id":"muse-gk6.9","depends_on_id":"muse-gk6","type":"parent-child","created_at":"2025-12-29T17:29:50.377223+01:00","created_by":"daemon"}]}
{"id":"muse-gyf","title":"Phase 2+3: CLIP embedding robustness improvements","description":"","notes":"Completed Phase 2 review fixes:\n1. Added retry logic with exponential backoff to CLIP image embedding\n2. Added 30s default timeout with AbortSignal.timeout()\n3. Added input validation for empty text/image\n4. Added missing barrel exports for searchImagesExecutor and findSimilarImagesExecutor\n5. Fixed ImageSearchHit type mismatch (string -\u003e EntityType/AssetType/ImageStyle)\n\nPhase 3 (Reference Image → Entity) NOT yet implemented.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T04:04:04.2019+01:00","updated_at":"2025-12-30T04:04:18.096925+01:00","closed_at":"2025-12-30T04:04:18.09693+01:00"}
{"id":"muse-i0z","title":"Expo Migration - Foundation Complete","description":"Migrated UI to Expo SDK 54 with Router. Includes: design-system (colors, tokens, theme), layout components (AppShell, Sidebar, AIPanel), file-based routing, responsive layout. Web build passes.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-07T20:20:30.844096+01:00","updated_at":"2026-01-07T20:20:46.323066+01:00","closed_at":"2026-01-07T20:20:46.323066+01:00","labels":["expo","foundation","ui"]}
{"id":"muse-j3z","title":"Expo UI - Convex Data Integration","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-07T20:20:24.459431+01:00","updated_at":"2026-01-07T20:20:24.459431+01:00","labels":["convex","expo","ui"]}
{"id":"muse-kco","title":"Landing Page Feature Demo GIFs","description":"## Scope\nAdd GIF/video demos for each feature on landing page (like Notion 3.0)\n\n## Demos Needed\n1. Entity auto-detection (paste text → entities appear)\n2. Consistency linter (eye color contradiction alert)\n3. World Graph visualization (pan/zoom)\n4. RAG Chat (streaming answer)\n\n## Technical\n- WebM for modern browsers, GIF fallback\n- Lazy load with intersection observer\n- Host on Supabase Storage or R2\n\n## Reference\n- Notion 3.0 landing page style\n- Cursor.ai demo videos\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T18:09:50.896096+01:00","updated_at":"2025-12-29T18:09:50.896096+01:00","labels":["marketing","polish","website"]}
{"id":"muse-kkn","title":"Progressive Disclosure Polish","description":"Polish items for progressive disclosure system:\n- Tutorial overlays (coach marks for first-time features)\n- Persist 'never ask' preferences to Supabase  \n- Wire ConsistencyLinter agent to UI (currently mock data)\n- Phase progression analytics (track unlock rates)\n- Customizable unlock thresholds in settings\n\nSee ARCHITECTURE_REVIEW.md section 5.5","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-29T09:02:31.343255+01:00","updated_at":"2025-12-29T09:02:31.343255+01:00","dependencies":[{"issue_id":"muse-kkn","depends_on_id":"muse-x3g","type":"blocks","created_at":"2025-12-29T09:03:32.078634+01:00","created_by":"daemon"}]}
{"id":"muse-l7s","title":"AI SDK 6 needsApproval Integration","description":"Integrated AI SDK 6 native needsApproval tool approval system. Added dynamic approval for sensitive tools (create_entity, update_entity, delete_entity, genesis_world, relationships). Updated SSE streaming, ai-saga endpoint, sagaClient, ToolResultCard UI, and agent-protocol types. Commit: 81ddffb","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T01:09:34.097247+01:00","updated_at":"2025-12-30T01:09:39.919327+01:00","closed_at":"2025-12-30T01:09:39.919327+01:00","labels":["ai","sdk"]}
{"id":"muse-mg3","title":"Testing on real devices","description":"Test mobile app on iOS/Android devices, website on various browsers","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-29T02:34:19.119262+01:00","updated_at":"2025-12-29T02:34:19.119262+01:00","dependencies":[{"issue_id":"muse-mg3","depends_on_id":"muse-xpl","type":"parent-child","created_at":"2025-12-29T02:34:42.463046+01:00","created_by":"daemon"},{"issue_id":"muse-mg3","depends_on_id":"muse-7r3","type":"blocks","created_at":"2025-12-29T02:34:50.085225+01:00","created_by":"daemon"}]}
{"id":"muse-nnl","title":"Expo UI - AI Tools Panel","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-07T20:20:24.720135+01:00","updated_at":"2026-01-07T20:20:24.720135+01:00","labels":["ai","expo","tools","ui"]}
{"id":"muse-o9p","title":"Session Indicator UI with conversation persistence","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T01:49:30.284726+01:00","updated_at":"2025-12-30T01:49:39.945895+01:00","closed_at":"2025-12-30T01:49:39.945895+01:00"}
{"id":"muse-tui","title":"Genre-Aware Entity Extensions - Enhance character/faction/location profiles with genre-specific fields (fantasy: race/class/alignment, sci-fi: species/homeworld, romance: relationship dynamics). Consider embeddings-based intelligence vs hard-coded schemas. Depends on MLP 2.0 completion.","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-30T02:54:22.812138+01:00","updated_at":"2025-12-30T02:54:22.812138+01:00"}
{"id":"muse-utc","title":"Implement clarity_check AI tool","description":"Add a new Saga tool **clarity_check** that finds word/phrase-level clarity problems:\n\n## Features Implemented\n- **5 Issue Categories**: ambiguous_pronoun, unclear_antecedent, cliche, filler_word, dangling_modifier\n- **Readability Metrics**: Flesch-Kincaid Grade, Reading Ease, avg words/sentence, word count\n- **Position-based Decorations**: Uses character offsets for accurate highlighting of repeated words\n- **Unified Issue Display**: Clarity issues appear alongside coach issues in the Style panel\n- **Quick Action + Command Palette**: Both accessible via sidebar and ⌘K\n\n## Files Created\n- packages/prompts/src/clarity.ts\n- supabase/functions/_shared/prompts/clarity.ts\n- supabase/functions/_shared/tools/clarity-check.ts\n- apps/web/src/tools/executors/clarityCheck.ts\n\n## Files Modified\n- packages/core/src/analysis/types.ts\n- packages/agent-protocol/src/index.ts\n- supabase/functions/_shared/tools/index.ts\n- supabase/functions/_shared/saga/executors.ts\n- supabase/functions/ai-saga/index.ts\n- apps/web/src/services/ai/sagaClient.ts\n- apps/web/src/tools/registry.ts\n- apps/web/src/tools/types.ts\n- apps/web/src/stores/analysis.ts\n- apps/web/src/components/console/StyleIssuesList.tsx\n- apps/web/src/components/console/StyleFixPreviewModal.tsx\n- apps/web/src/components/console/CoachView.tsx\n- apps/web/src/components/console/AISidebar/QuickActions.tsx\n- apps/web/src/commands/ai-commands.ts\n- packages/editor/src/extensions/style-decoration.ts\n- apps/web/src/styles/globals.css","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T17:12:20.029148+01:00","updated_at":"2025-12-29T17:13:25.084001+01:00","closed_at":"2025-12-29T17:13:25.084001+01:00"}
{"id":"muse-utr","title":"Writer Memory Layer - Centralized Memory System with Qdrant","description":"## Overview\nCentralized memory layer for writer personalization. Uses Qdrant for vector storage with CRUD operations (write, update, read/call, delete).\n\n## Tagline\n**\"Your story's database that organizes itself\"** - extends to remembering the writer's style, decisions, and preferences.\n\n## Architecture\n\n### Memory Types\n1. **Style Memory** - Writing patterns, sentence length, metaphor usage\n2. **Decision Memory** - Canon decisions (\"Marcus has blue eyes\")\n3. **Preference Memory** - Rejected suggestions, naming preferences\n4. **Session Memory** - Conversation context across sessions\n\n### Infrastructure (Reuse Existing)\n- **Qdrant Client**: `supabase/functions/_shared/qdrant.ts`\n- **Embeddings**: `supabase/functions/_shared/deepinfra.ts` (Qwen3-Embedding-8B, 4096 dims)\n- **Collection**: `saga_vectors` with `type: \"memory\"` filter\n\n### Payload Structure\n```typescript\n{\n  project_id: string,           // Scope to project\n  user_id: string,              // Per-user memories\n  type: \"memory\",               // Type discriminator\n  memory_id: string,            // Unique memory ID\n  memory_type: \"style\" | \"decision\" | \"preference\" | \"session\",\n  content: string,              // Memory content (embedded)\n  source?: {                    // Origin\n    document_id?: string,\n    entity_id?: string,\n    session_id?: string\n  },\n  weight?: number,              // Importance score (1-10)\n  created_at: string,\n  last_accessed_at?: string     // Recency-based retrieval\n}\n```\n\n### Point ID Convention\n- `mem_${userId}_${memoryId}` for user-scoped memories\n- `mem_proj_${projectId}_${memoryId}` for project-scoped memories\n\n## New Edge Functions\n\n### 1. ai-memory-write\n```typescript\nPOST /ai-memory-write\n{\n  action: \"create\" | \"update\",\n  memory: {\n    memoryType: string,\n    content: string,\n    projectId?: string,\n    source?: object,\n    weight?: number\n  }\n}\n```\n\n### 2. ai-memory-read (similar to ai-search)\n```typescript\nPOST /ai-memory-read\n{\n  query: string,              // Semantic search\n  projectId?: string,         // Optional project filter\n  memoryTypes?: string[],     // Filter by type\n  limit?: number,\n  includeGlobal?: boolean     // Include user-level memories\n}\n```\n\n### 3. ai-memory-delete\n```typescript\nPOST /ai-memory-delete\n{\n  memoryId?: string,          // Delete specific\n  filter?: {                  // Or delete by filter\n    projectId?: string,\n    memoryType?: string,\n    olderThan?: string        // ISO date\n  }\n}\n```\n\n## Web Client: packages/memory/\n```\npackages/memory/\n├── src/\n│   ├── index.ts           # Re-exports\n│   ├── types.ts           # Memory types\n│   ├── client.ts          # Edge function client\n│   └── hooks/\n│       ├── useMemory.ts   # CRUD hook\n│       └── useMemoryContext.ts  # Auto-inject memories into AI calls\n```\n\n## Integration Points\n1. **AI Chat**: Inject relevant memories into system prompt\n2. **Linter**: Check decisions against memory for contradictions\n3. **Entity Creation**: Remember naming patterns and preferences\n4. **Style Analysis**: Store and recall style preferences\n\n## Success Criteria\n- [ ] Edge functions created (write, read, delete)\n- [ ] Memory package with client and hooks\n- [ ] Memories stored in Qdrant with proper payload\n- [ ] AI chat injects relevant memories\n- [ ] Style learning on document save\n- [ ] Decision tracking on entity updates\n","notes":"MLP 2.x complete: Postgres as source-of-truth with Qdrant as best-effort vector index. Graceful degradation, session isolation, token budgeting, batch operations. 4/7 subtasks closed. Follow-up (6b563fa): Wired supabase client through ai-saga prepareSagaContext() to enable Postgres fallback.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-29T17:45:24.314226+01:00","updated_at":"2025-12-30T01:23:49.260501+01:00","labels":["ai","memory","personalization","qdrant"]}
{"id":"muse-utr.1","title":"Memory Edge Functions (write, read, delete)","description":"## Scope\nCreate three edge functions for memory CRUD operations.\n\n## Functions\n\n### 1. supabase/functions/ai-memory-write/index.ts\n- Accepts memory content + metadata\n- Generates embedding via DeepInfra\n- Upserts to Qdrant with `type: \"memory\"`\n- Handles create vs update (by memoryId)\n\n### 2. supabase/functions/ai-memory-read/index.ts\n- Accepts query string (semantic search)\n- Optional filters: projectId, memoryTypes[], userId\n- Returns scored memories with full payload\n- Supports limit + recency weighting\n\n### 3. supabase/functions/ai-memory-delete/index.ts\n- Delete by memoryId (single)\n- Delete by filter (batch)\n- Uses deletePointsByFilter for cleanup\n\n## Reuse\n- Import from `_shared/qdrant.ts` and `_shared/deepinfra.ts`\n- Same auth pattern as ai-embed, ai-search\n","notes":"Completed in MLP 2.x: ai-memory-write (batch + Postgres dual-write), ai-memory-read (fallback + TTL), ai-memory-delete (soft-delete). All with Qdrant retry/backoff.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T17:46:47.681559+01:00","updated_at":"2025-12-29T22:00:00.390552+01:00","closed_at":"2025-12-29T22:00:00.390557+01:00","labels":["ai","edge","memory","qdrant"],"dependencies":[{"issue_id":"muse-utr.1","depends_on_id":"muse-utr","type":"parent-child","created_at":"2025-12-29T17:46:47.682685+01:00","created_by":"daemon"}]}
{"id":"muse-utr.2","title":"Memory Client Package (@mythos/memory)","description":"## Scope\nCreate packages/memory with typed client and React hooks.\n\n## Structure\n```\npackages/memory/\n├── package.json\n├── tsconfig.json\n└── src/\n    ├── index.ts           # Re-exports\n    ├── types.ts           # Memory, MemoryType, MemoryPayload\n    ├── client.ts          # writeMemory, readMemory, deleteMemory\n    └── hooks/\n        ├── useMemory.ts         # CRUD hook with loading/error\n        └── useMemoryContext.ts  # Auto-retrieve memories for AI\n```\n\n## Client API\n```typescript\n// Write memory\nwriteMemory(content: string, opts: MemoryOptions): Promise\u003cMemory\u003e\n\n// Read memories (semantic search)\nreadMemory(query: string, opts?: ReadOptions): Promise\u003cMemory[]\u003e\n\n// Delete memory\ndeleteMemory(memoryId: string): Promise\u003cvoid\u003e\ndeleteMemories(filter: MemoryFilter): Promise\u003cvoid\u003e\n```\n","notes":"Completed: @mythos/memory package with client.ts (write, writeBatch, read, delete, learnStyle methods), types.ts re-exports from agent-protocol.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T17:46:47.893407+01:00","updated_at":"2025-12-29T22:00:00.541474+01:00","closed_at":"2025-12-29T22:00:00.541478+01:00","labels":["ai","client","memory"],"dependencies":[{"issue_id":"muse-utr.2","depends_on_id":"muse-utr","type":"parent-child","created_at":"2025-12-29T17:46:47.89421+01:00","created_by":"daemon"}]}
{"id":"muse-utr.3","title":"Memory Integration with AI Chat","description":"## Scope\nInject relevant memories into AI chat context.\n\n## Implementation\nBefore calling LLM:\n1. Query memories with user message as search\n2. Filter by projectId + memoryTypes\n3. Inject into system prompt with CANON/STYLE/PREFERENCE labels\n","notes":"Completed: ai-chat and ai-saga both retrieve memory context with proper owner isolation, conversationId support for session continuity.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T17:46:48.104858+01:00","updated_at":"2025-12-29T22:00:00.692063+01:00","closed_at":"2025-12-29T22:00:00.692066+01:00","labels":["ai","chat","memory"],"dependencies":[{"issue_id":"muse-utr.3","depends_on_id":"muse-utr","type":"parent-child","created_at":"2025-12-29T17:46:48.105866+01:00","created_by":"daemon"}]}
{"id":"muse-utr.4","title":"Auto-Learn Writer Style from Documents","description":"## Scope\nAutomatically extract and store style memories from documents.\n\n## Trigger\n- On document save (after existing embedding)\n- Debounced, not every keystroke\n\n## Style Analysis\nUse LLM to extract style characteristics:\n- Sentence length preference\n- Dialogue density\n- Metaphor usage\n- POV and tense patterns\n","notes":"In progress: ai-learn-style function exists. MLP 2.x added memory write integration.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-29T17:46:48.337435+01:00","updated_at":"2025-12-29T22:00:11.542949+01:00","labels":["ai","memory","style"],"dependencies":[{"issue_id":"muse-utr.4","depends_on_id":"muse-utr","type":"parent-child","created_at":"2025-12-29T17:46:48.338545+01:00","created_by":"daemon"}]}
{"id":"muse-utr.5","title":"Track Canon Decisions as Memories","description":"## Scope\nAutomatically create decision memories when writers make canonical choices.\n\n## Triggers\n1. Entity Creation/Update - store attribute decisions\n2. Linter Fix Acceptance - store corrections\n3. AI Chat Confirmations - when writer confirms facts\n","notes":"In progress: Decision memories stored with scope=project. Integration with entity updates needed.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-29T17:46:48.559747+01:00","updated_at":"2025-12-29T22:00:11.704795+01:00","labels":["ai","canon","memory"],"dependencies":[{"issue_id":"muse-utr.5","depends_on_id":"muse-utr","type":"parent-child","created_at":"2025-12-29T17:46:48.560458+01:00","created_by":"daemon"}]}
{"id":"muse-utr.6","title":"Context Builder Package (@mythos/context)","description":"## Scope\nUnified context builder that combines Profile + World + Memory + RAG for AI requests.\n\n## Package: packages/context/\n\n```\npackages/context/\n├── package.json\n├── tsconfig.json\n└── src/\n    ├── index.ts           # Re-exports\n    ├── types.ts           # Context types\n    ├── builders/\n    │   ├── profile.ts     # getProfileContext()\n    │   ├── world.ts       # getWorldContext()\n    │   ├── memory.ts      # getMemoryContext()\n    │   └── rag.ts         # getRAGContext()\n    ├── cache/\n    │   ├── memoryCache.ts # Zustand slice for hot cache\n    │   └── localStorage.ts # Persistence between sessions\n    └── unified.ts         # buildAIContext()\n```\n\n## Context Types\n\n```typescript\ninterface ProfileContext {\n  genre?: string;\n  namingCulture?: string;\n  namingStyle?: string;\n  logicStrictness?: string;\n}\n\ninterface WorldContext {\n  entities: EntitySummary[];\n  relationships: RelationshipSummary[];\n}\n\ninterface MemoryContext {\n  canonDecisions: Memory[];\n  stylePatterns: Memory[];\n  preferences: Memory[];\n}\n\ninterface RAGContext {\n  documents: ContextItem[];\n  entities: ContextItem[];\n}\n\ninterface UnifiedContext {\n  profile: ProfileContext;\n  world: WorldContext;\n  memory: MemoryContext;\n  rag: RAGContext;\n  formatted: string; // Ready for system prompt\n}\n```\n\n## Caching Strategy\n\n1. **Hot Cache** (Zustand)\n   - Recent memories from current session\n   - Style profile computed from memories\n   - TTL: session lifetime\n\n2. **Warm Cache** (localStorage)\n   - Last 50 memories accessed\n   - Persists between sessions\n   - TTL: 7 days\n\n3. **Cold Storage** (Qdrant)\n   - All memories\n   - Semantic search required\n   - No TTL (permanent)\n\n## Integration\n\n```typescript\n// In ai-chat edge function\nconst contextBuilder = createContextBuilder(supabase, qdrant);\nconst context = await contextBuilder.buildAIContext({\n  userId,\n  projectId,\n  query: userMessage,\n  includeMemory: true,\n  includeWorld: true,\n  includeRAG: true\n});\n\nconst systemPrompt = context.formatted;\n```\n","notes":"In progress: @mythos/context package exists with builders.ts. Profile and world context building complete.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-29T17:53:21.566456+01:00","updated_at":"2025-12-29T22:00:11.849454+01:00","labels":["ai","context","memory"],"dependencies":[{"issue_id":"muse-utr.6","depends_on_id":"muse-utr","type":"parent-child","created_at":"2025-12-29T17:53:21.567951+01:00","created_by":"daemon"}]}
{"id":"muse-utr.7","title":"Memory Caching Layer (Zustand + localStorage)","description":"## Scope\nAdd caching layers for memory to reduce Qdrant calls and improve response time.\n\n## Zustand Store: memoryStore\n\n```typescript\ninterface MemoryState {\n  // Hot cache - recent memories\n  recentMemories: Memory[];\n  \n  // Computed style profile\n  styleProfile: StyleProfile | null;\n  \n  // Cache metadata\n  lastFetched: number;\n  cacheHits: number;\n  cacheMisses: number;\n}\n\ninterface MemoryActions {\n  addToCache(memories: Memory[]): void;\n  getFromCache(query: string, opts?: CacheOptions): Memory[] | null;\n  invalidateCache(projectId?: string): void;\n  computeStyleProfile(memories: Memory[]): StyleProfile;\n}\n```\n\n## localStorage Persistence\n\n```typescript\nconst MEMORY_CACHE_KEY = \"mythos:memory:cache\";\nconst MEMORY_CACHE_TTL = 7 * 24 * 60 * 60 * 1000; // 7 days\n\ninterface PersistedCache {\n  memories: Memory[];\n  updatedAt: number;\n}\n\n// Sync to localStorage on changes\nuseEffect(() =\u003e {\n  const cache: PersistedCache = {\n    memories: state.recentMemories.slice(0, 50),\n    updatedAt: Date.now()\n  };\n  localStorage.setItem(MEMORY_CACHE_KEY, JSON.stringify(cache));\n}, [state.recentMemories]);\n\n// Load from localStorage on init\nconst loadPersistedCache = (): Memory[] =\u003e {\n  const cached = localStorage.getItem(MEMORY_CACHE_KEY);\n  if (\\!cached) return [];\n  \n  const parsed: PersistedCache = JSON.parse(cached);\n  if (Date.now() - parsed.updatedAt \u003e MEMORY_CACHE_TTL) {\n    return []; // Expired\n  }\n  return parsed.memories;\n};\n```\n\n## Cache Strategy\n\n1. **Read**: Check Zustand → Check localStorage → Fetch from Qdrant\n2. **Write**: Update Qdrant → Update Zustand → Sync to localStorage\n3. **Invalidate**: On project switch, logout, or explicit clear\n","notes":"Completed in MLP 2.x: Zustand store with conversation-scoped session cache, pruning for old conversations, setSessionCache/getSession/invalidateSession APIs.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T17:53:21.760493+01:00","updated_at":"2025-12-29T22:00:00.847435+01:00","closed_at":"2025-12-29T22:00:00.847439+01:00","labels":["cache","memory","zustand"],"dependencies":[{"issue_id":"muse-utr.7","depends_on_id":"muse-utr","type":"parent-child","created_at":"2025-12-29T17:53:21.762088+01:00","created_by":"daemon"}]}
{"id":"muse-utr.8","title":"MLP 2.x Robustness: Postgres fallback, cache pruning, code consolidation","description":"## Summary\nRobustness improvements and code consolidation for MLP 2.x Writer Memory Layer.\n\n## Changes Made (commit aab1555)\n\n### Immediate Fixes\n- Fixed import path in saga.ts\n- Standardized naming: styleRules→style, sessionContext→session\n\n### Postgres Fallback (Graceful Degradation)\n- Implemented retrieveMemoryContextFromPostgres() using search_memories RPC\n- Falls back to Postgres when Qdrant is unavailable\n- Added supabaseClient parameter to retrieveMemoryContext()\n\n### Cache Improvements\n- Added runtime cache pruning (auto-prunes every 5 minutes)\n- Added project count limit (MAX_PROJECTS_IN_CACHE = 20)\n- Added pruneOldProjects() and pruneExpired() methods\n\n### Code Consolidation\n- Created _shared/memory/parsers.ts with parseMemoryFromPayload()\n- Created _shared/memory/filters.ts with buildMemoryFilter()\n- Updated retrieval.ts and ai-memory-read to use shared modules\n\n### Performance Fixes\n- Fixed jitter calculation to use AWS-style full jitter\n- Validated ownerId for non-empty string\n- Added composite index for session queries (migration 017)\n\n## Files Changed\n- muse/packages/memory/src/store.ts\n- muse/supabase/functions/_shared/memory/retrieval.ts\n- muse/supabase/functions/_shared/memory/types.ts\n- muse/supabase/functions/_shared/memory/filters.ts (new)\n- muse/supabase/functions/_shared/memory/parsers.ts (new)\n- muse/supabase/migrations/20240101000017_memories_session_index.sql (new)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T22:13:57.488071+01:00","updated_at":"2025-12-29T22:14:33.172235+01:00","closed_at":"2025-12-29T22:14:33.172235+01:00","dependencies":[{"issue_id":"muse-utr.8","depends_on_id":"muse-utr","type":"parent-child","created_at":"2025-12-29T22:13:57.489494+01:00","created_by":"daemon"}]}
{"id":"muse-x3g","title":"Progressive Structure System - Implementation Complete","description":"Implemented Progressive Structure System for Mythos IDE. Provides two entry points for project creation (Architect vs Gardener modes) with progressive feature disclosure for Gardener mode.\n\n## Key Components\n\n### 1. Extended Progressive Store (`packages/state/src/progressive.ts`)\n- Per-project progressive state with phases 1-4\n- Nudge system: EntityDiscoveryNudge, ConsistencyChoiceNudge, FeatureUnlockNudge\n- UI module unlock tracking (UIModuleId type)\n- Actions: setActiveProject, ensureProject, setCreationMode, setPhase, unlockModule, showNudge, dismissNudge\n- Selectors: useProgressivePanelVisibility, useIsGardenerMode, useActiveNudge, useActivePhase\n\n### 2. Dual Entry Points (`apps/web/src/components/modals/ProjectCreateModal.tsx`)\n- \"Start Writing\" (Gardener) - Phase 1, editor only\n- \"Build Your World\" (Architect) - Phase 4, all features\n- Initializes progressive state on project creation\n\n### 3. Progressive State Initialization (`apps/web/src/hooks/useProjectLoader.ts`)\n- Initializes progressive state when project loads\n- Legacy projects default to architect mode (full features)\n\n### 4. UI Panel Gating (`apps/web/src/components/Layout.tsx`)\n- Manifest and Console conditionally render via useProgressivePanelVisibility()\n- Gardener mode hides panels until unlocked\n- Canvas adapts size based on visible panels\n\n### 5. Progressive Components (`apps/web/src/components/progressive/`)\n- ProgressiveNudge.tsx - Subtle notifications for entity discovery, consistency, feature unlocks\n- ProgressiveStructureController.tsx - Phase transitions, word count tracking, paste detection\n- index.ts - Exports\n\n### 6. Entity Detection Updates (`apps/web/src/hooks/useEntityDetection.ts`)\n- Added autoOpenModal option (can disable for nudge flow)\n- Added onDetectionComplete callback\n- Stores pending entities in progressive store\n\n### 7. Consistency Choice Modal (`apps/web/src/components/modals/ConsistencyChoiceModal.tsx`)\n- Canon choice resolution for consistency issues\n- Part of Phase 3 progressive disclosure\n\n## Phase Behavior Matrix\n| Mode | Phase | Visible Panels |\n|------|-------|----------------|\n| Gardener | 1 | Editor only |\n| Gardener | 2 | Editor + Manifest (after entity detection at ~500 words) |\n| Gardener | 3 | Editor + Manifest + Console (after first consistency issue) |\n| Gardener | 4 | All panels |\n| Architect | 4 | All panels from start |\n\n## Phase Transition Triggers\n- Phase 1→2: Word count threshold (~500 words) OR substantial paste\n- Phase 2→3: First consistency/contradiction detected by linter\n- Phase 3→4: User resolves consistency issue\n\n## Integration Points\n- Genesis Wizard can use progressive store for onboarding\n- Milestones can trigger feature unlock nudges\n- Mobile capture hub shares progressive state","acceptance_criteria":"## Completed\n- [x] Per-project progressive state in Zustand store\n- [x] Phase types (1-4) and UIModuleId enum\n- [x] Nudge system (entity_discovery, consistency_choice, feature_unlock)\n- [x] Dual entry points in ProjectCreateModal (Gardener/Architect)\n- [x] Progressive state initialization on project load\n- [x] UI panel gating in Layout.tsx\n- [x] ProgressiveNudge component with dismiss/snooze/never-ask\n- [x] ProgressiveStructureController for phase transitions\n- [x] useEntityDetection nudge mode support\n- [x] ConsistencyChoiceModal for Phase 3\n- [x] TypeScript compiles cleanly (web + state packages)\n\n## Future Enhancements\n- [ ] Persistence of progressive state to localStorage/DB\n- [ ] Writing time tracking with idle detection\n- [ ] Feature unlock suggestions based on usage patterns\n- [ ] Timeline/World Graph progressive unlocks\n- [ ] Integration with linter for Phase 2→3 trigger","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-29T07:30:16.062167+01:00","updated_at":"2025-12-29T07:30:29.64396+01:00","closed_at":"2025-12-29T07:30:29.64396+01:00","labels":["architect","gardener","progressive","state","ui"]}
{"id":"muse-xpl","title":"Platform Launch Tasks","description":"Epic for website and mobile app launch tasks","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-29T02:34:09.138056+01:00","updated_at":"2025-12-29T02:34:09.138056+01:00"}
{"id":"muse-z93","title":"Expo UI - Native Builds (iOS/macOS)","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-07T20:20:24.952062+01:00","updated_at":"2026-01-07T20:20:24.952062+01:00","labels":["expo","ios","macos","native","ui"]}
{"id":"muse-ze4","title":"Enable Qdrant scalar quantization when saga_vectors reaches 100K vectors","description":"## Trigger\n- Monitor saga_vectors collection point count\n- Enable when points_count \u003e= 100,000\n\n## Benefits at scale\n- 4x memory reduction (4096-dim vectors)\n- Faster search with acceptable quality loss (~1-2%)\n\n## Implementation\n1. Check status: curl https://qdrant.cascada.vision/collections/saga_vectors | jq '.result.points_count'\n2. When threshold reached, enable scalar quantization via API\n3. Monitor optimizer_status until re-indexing complete\n4. Test search quality before/after\n\n## Reference\n- Qdrant docs: https://qdrant.tech/documentation/guides/quantization/\n- Current config: 4096 dims, Cosine, on_disk=true","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-29T23:52:06.495531+01:00","updated_at":"2025-12-29T23:52:06.495531+01:00","labels":["infra","qdrant"]}
